"use strict";!function(a,b,c){function d(a){var b=document.createEvent("Event");b.initEvent(a,!0,!0),document.dispatchEvent(b)}function e(a,b){a=l(a),a&&(t[a]?t[a].status=b:t[a]={status:b})}function f(a){return a=l(a),t[a]?t[a].status:H.unauthorized}function g(a){return a=l(a),t[a]?t[a].token:null}function h(a){return a=l(a),t[a]?t[a].userId:null}function i(){return window.location.host===v&&(t=JSON.parse(sessionStorage.getItem("Apperyio.sociallogin.tokens")),sessionStorage.removeItem("Apperyio.sociallogin.tokens")),"[object Object]"===Object.prototype.toString.call(t)?t:{}}function j(a){var b,c={};if(-1===a.indexOf("?"))return c;if(b=a.indexOf("#")>-1?a.slice(a.indexOf("?"),a.indexOf("#")):a.slice(a.indexOf("?")),b.length>1)for(var d=0,e=b.substr(1).split("&");d<e.length;d++){var f=e[d].split("=");c[f[0]]=f[1]}return c}function k(){return a.Deferred()}function l(a){return a?a:s}function m(b,c,d,e,f,h){b=l(b);var i={"X-Appery-Database-Id":b,"Content-Type":"application/json"};!f&&g(b)&&(i["X-Appery-Session-Token"]=g(b));var j=k();return a.ajax({url:c,headers:i,data:e,method:d}).then(function(a){h?h(a,b,j):j.resolve(a)},function(a){j.reject(a)}),j.promise()}function n(a,b,c,f,g,h,i){d(I.dbLoginStart),e(f,H.inProgress);var j={verifier:b,token:c,provider:h,appId:g,callback:i};m(f,y,"POST",JSON.stringify(j),!1,p).then(function(b){a&&a.resolve(b)},function(b){d(I.dbLoginEnd),e(f,H.error),a&&a.reject(b)})}function o(){return-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")}function p(a,b,c){t[b]={token:a.sessionToken,userId:a._id,status:H.authorized},d(I.dbLoginEnd),c.resolve(a.sessionToken)}function q(a,b,c,d,e,f){function g(c){0===c.url.indexOf(d)&&(u=j(c.url),u.code?(n(m,u.code,"",a,b,e,d),h.close()):(m.reject("Access not granted"),h.close()))}var h,i=c+"?client_id="+b+"&redirect_uri="+d+"&scope="+f+"&response_type=code",m=k();return o()?(h=window.open(i,"_blank","location=yes"),h.addEventListener("loadstart",g)):(window.location.host===v&&sessionStorage.setItem("Apperyio.sociallogin.tokens",JSON.stringify(t)),localStorage.setItem("Apperyio.sociallogin.socialnetwork",e),localStorage.setItem("Apperyio.sociallogin.clientId",b),localStorage.setItem("Apperyio.sociallogin.callback",d),localStorage.setItem("Apperyio.sociallogin.dbId",a=l(a)),window.open(i,"_self")),m.promise()}function r(a,b,c,d,e){function f(d){var f=d.token,i=c+"?oauth_token="+f;o()?(h=window.open(i,"_blank","location=yes"),h.addEventListener("loadstart",g)):(window.location.host===v&&sessionStorage.setItem("Apperyio.sociallogin.tokens",JSON.stringify(t)),localStorage.setItem("Apperyio.sociallogin.socialnetwork",e),localStorage.setItem("Apperyio.sociallogin.clientId",b),localStorage.setItem("Apperyio.sociallogin.dbId",a=l(a)),window.open(i,"_self"))}function g(c){0===c.url.indexOf(d)&&(p=j(c.url),p.oauth_token&&p.oauth_verifier?(n(i,p.oauth_verifier,p.oauth_token,a,b,e),h.close()):(i.reject("Access not granted"),h.close()))}var h,i=k(),p={provider:e,appId:b,callback:d};return m(a,z,"GET",p,!0,f),i.promise()}var s,t={},u=j(window.location.href),v="appery.io",w="https://api."+v+"/rest/1/db/",x=w+"oauth/",y=x+"login/",z=x+"token/",A=x+"logout?provider=<provider>",B=w+"users/",C=w+"login/",D=w+"logout/",E=B+"me/",F=B+"<user_id>",G={twitter:{id:"twitter",baseUrl:"https://api.twitter.com/oauth/authenticate"},facebook:{id:"facebook",baseUrl:"https://www.facebook.com/dialog/oauth"},google:{id:"google",baseUrl:"https://accounts.google.com/o/oauth2/auth"}},H={unauthorized:"unauthorized",inProgress:"inProgress",authorized:"authorized",error:"error"},I={dbLoginStart:"dbloginstart",dbLoginEnd:"dbloginend"};!o()&&u.code&&(t=i(),n(null,u.code,null,localStorage.getItem("Apperyio.sociallogin.dbId"),localStorage.getItem("Apperyio.sociallogin.clientId"),localStorage.getItem("Apperyio.sociallogin.socialnetwork"),localStorage.getItem("Apperyio.sociallogin.callback"))),!o()&&u.oauth_token&&u.oauth_verifier&&(t=i(),n(null,u.oauth_verifier,u.oauth_token,localStorage.getItem("Apperyio.sociallogin.dbId"),localStorage.getItem("Apperyio.sociallogin.clientId"),localStorage.getItem("Apperyio.sociallogin.socialnetwork"),localStorage.getItem("Apperyio.sociallogin.callback"))),b.User={getToken:g,getUserId:h,getStatus:f,setDefaultDB:function(a){s=a},createUser:function(a,b){return d(I.dbLoginStart),e(b,H.inProgress),m(b,B,"POST",JSON.stringify(a),!0,p)},login:function(a,b){return d(I.dbLoginStart),e(b,H.inProgress),m(b,C,"GET",a,!0,p)},logout:function(a){function b(a,b,d){c.invalidate(b),d.resolve()}var c=this;return m(a,D,"GET",{},!1,b)},findUsers:function(a,b){return m(b,B,"GET",a)},isLogged:function(a,b){return m(b,E,"GET",a)},updateUser:function(a,b){return m(b,F.replace("<user_id>",this.getUserId(b)),"PUT",JSON.stringify(a))},invalidate:function(a){return a=l(a),t[a]?(t[a]=c,!0):!1},logoutOauth:function(a,b){return b=l(b),m(b,A.replace("<provider>",a),"DELETE",{})},loginTwitter:function(a,b,c){return r(c,a,G.twitter.baseUrl,b,G.twitter.id)},loginFB:function(a,b,c){return q(c,a,G.facebook.baseUrl,b,G.facebook.id,"")},loginGoogle:function(a,b,c){return q(c,a,G.google.baseUrl,b,G.google.id,"profile")}}}(jQuery,Apperyio);