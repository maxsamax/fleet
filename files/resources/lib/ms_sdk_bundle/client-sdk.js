!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["lodash","q","EventEmitter","localforage","moment","tv4","CryptoJS","underscore-query"],function(c,d,e,f,g,h,i){return b(a,d,e,f,c,g,h,i)}):a.AppClient=b(a,a.Q,a.EventEmitter,a.localforage,a._,a.moment,a.tv4,a.CryptoJS)}(this,function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){this.data=a,this.httpRequest=b}function j(a,b,c){this.autogeneratedId=a,this.realId=b,this.data=c}function k(a,b,c){this.userName=a,this.secret=h.MD5(b),!e.isUndefined(c)&&c&&(this.password=b)}function l(a){this.name="InitializationError",this.message=a||"Error occurred during Client SDK initialization"}function m(a){this.name="ValidationError",this.message=a||"Error occurred during Client SDK initialization"}e.isUndefined(e.cloneDeep)&&e.mixin({cloneDeep:function(a){return JSON.parse(JSON.stringify(a))}}),e.isUndefined(e.endsWith)&&e.mixin({endsWith:function(a,b){var c=a.length-b.length;return c>=0&&a.indexOf(b,c)===c}}),e.isUndefined(e.startsWith)&&e.mixin({startsWith:function(a,b){return 0===a.lastIndexOf(b,0)}}),e.isUndefined(e.slice)&&e.mixin({slice:function(a,b,c){return a.slice(b,c)}});var n=a.console,o={};Object.defineProperties(o,{INITIAL:{enumerable:!0,value:"initial"},OFFLINE:{enumerable:!0,value:"offline"},ONLINE:{enumerable:!0,value:"online"},SYNCHRONIZING:{enumerable:!0,value:"synchronizing"},SYNC_FAILED:{enumerable:!0,value:"sync_failed"}});var p=function(){e.bindAll(this,"init","initOffline","initOnline","getModelListOffline","getModelsMetaDataOnline","initDAOOffline","initDAOOnline","setSessionToken","login","logout","dao","folder","isOffline","isOnline","goOffline","goOnline","retrySync","resetFailedSync","_pushDeferredActionIntoQueue","_executeDeferredActionsQueue","_getDeferredActionsForModel","_removeDeferredAction","_persistDeferredActionsQueue","synchronize","_persistUsersData","invoke"),this._stateStorageKey=null,this._deferredActionsStorageKey=null,this._modelListStorageKey=null,this._currentUser=null,this.state=o.INITIAL,this.settings={rest_api_version:"1",isDataValidationEnabled:!0},this._daoMap={},this._deferredActions=null,this._usersData=null};p.prototype=e.clone(c.prototype),p.prototype.State=o,p.prototype.init=function(a){return e.isUndefined(this.initPromise)?(this.initPromise=b.Promise(function(b,c){if(n.log("Client SDK: init"),e.extend(this.settings,a),!this.settings.domain)throw new l("Required setting 'domain' is empty");if(!this.settings.apiKey)throw new l("Required setting 'apiKey' is empty");if(!/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/.test(this.settings.domain))throw new l("Setting 'domain' is invalid");var f=this.settings._url={};f.meta="https://api."+this.settings.domain+"/rest/"+this.settings.rest_api_version+"/apiexpress/meta",f.rest="https://api."+this.settings.domain+"/rest/"+this.settings.rest_api_version+"/apiexpress/api",f.security="https://api."+this.settings.domain+"/rest/"+this.settings.rest_api_version+"/apiexpress/security",this._modelListStorageKey="sdk-model-list",this._deferredActionsStorageKey="sdk-deferred-actions",this._stateStorageKey="sdk-state",this._usersDataStorageKey="sdk-users-data",d.config({name:"ms:"+this.settings.domain+":"+this.settings.apiKey,driver:[d.INDEXEDDB,d.LOCALSTORAGE]}),b()}.bind(this)).then(function(){return b.Promise(function(a,b){d.getItem(this._usersDataStorageKey,function(c,d){c?b(c):a(this._usersData=d||[])}.bind(this))}.bind(this))}.bind(this)).then(function(){return b.Promise(function(a,b){d.getItem(this._deferredActionsStorageKey,function(c,d){c?b(c):a(this._deferredActions=d||[])}.bind(this))}.bind(this))}.bind(this)).then(function(){return b.Promise(function(a,b){d.getItem(this._stateStorageKey,function(c,f){if(c)b(c);else{var g=this.settings.currentState,h=f,i=!1;e.isUndefined(g)||e.isNull(g)||!e.contains(e.values(o),g)||g!==o.ONLINE&&g!==o.OFFLINE||e.isUndefined(h)||e.isNull(h)||!e.contains(e.values(o),h)||h===o.SYNC_FAILED||h===o.SYNCHRONIZING||h===g||(f=g,i=!0),e.contains(e.values(o),f)?this.state=f:(this.state=o.ONLINE,i=!0),i?d.setItem(this._stateStorageKey,this.state,function(c,d){c?b(c):(this.emit("statechange",d),a(d))}.bind(this)):(this.emit("statechange",f),a(f))}}.bind(this))}.bind(this))}.bind(this)).then(function(){var a;return a=this.isOffline()?this.initOffline():this.initOnline(),a=a.then(function(){this.emit("init")}.bind(this)),a=a["catch"](function(a){return n.error(a),b.reject(a)}.bind(this)),a.then(function(){return this}.bind(this))}.bind(this)),this.initPromise):this.initPromise},p.prototype.synchronize=function(){return b.Promise(function(a,b){d.setItem(this._stateStorageKey,o.SYNCHRONIZING,function(c,d){c?b(c):(this.state=d,this.emit("statechange",d),a())}.bind(this))}.bind(this)).then(this._executeDeferredActionsQueue).then(function(){return b.Promise(function(a,b){d.setItem(this._stateStorageKey,o.ONLINE,function(c,d){c?b(c):(this.state=d,this.emit("statechange",d),a())}.bind(this))}.bind(this))}.bind(this))["catch"](function(a){var c=a;return n.error("Error going online: "+a),b.Promise(function(a,b){d.setItem(this._stateStorageKey,o.SYNC_FAILED,function(a,d){a?b(a):(this.state=d,this.emit("statechange",d),b(c))}.bind(this))}.bind(this))}.bind(this))},p.prototype.initOnline=function(){return this.getModelsMetaDataOnline().then(function(a){return this.settings.isProjectSecured=a.isSecurity,this._daoMap={},a.models}.bind(this)).then(this.initDAOOnline).then(function(){return this.settings.isProjectSecured?b.Promise(function(a,b){d.setItem(this._stateStorageKey,o.ONLINE,function(c,d){c?b(c):(this.state=d,this.emit("statechange",d),a())}.bind(this))}.bind(this)):this.synchronize()}.bind(this))},p.prototype.initOffline=function(){return this.getModelListOffline().then(function(a){return this._daoMap={},a}.bind(this)).then(this.initDAOOffline)},p.prototype.isOffline=function(){return this.state===o.OFFLINE},p.prototype.isOnline=function(){return this.state===o.ONLINE},p.prototype.goOffline=function(){if(this.state!==o.ONLINE)return n.warn("AppClient can go offline state from online state only. Current SDK State: "+this.state),b();var a=b.fcall(this.initOffline);return a=a.then(function(){return b.Promise(function(a,b){d.setItem(this._stateStorageKey,o.OFFLINE,function(c,d){c?b(c):(this.state=d,this.emit("statechange",d),a(d))}.bind(this))}.bind(this))}.bind(this))},p.prototype.goOnline=function(){if(this.state!==o.OFFLINE)return n.warn("AppClient can go online state from offline state only. Current SDK State: "+this.state),b();var a=b.fcall(this.initOnline);return null!==this._currentUser&&this._currentUser instanceof k&&(a=a.then(function(){return n.log("goOnline: Login user"),this.login(this._currentUser.userName,this._currentUser.password)}.bind(this)),a=a.then(this.synchronize)),a},p.prototype.retrySync=function(){return this.state!==o.SYNC_FAILED?(n.warn("AppClient can retry synchronization being in failed sync state only"),b()):(this.state=o.OFFLINE,this.goOnline()["catch"](function(a){return this.state=o.SYNC_FAILED,b.reject(a)}.bind(this)))},p.prototype.resetFailedSync=function(){if(this.state!==o.SYNC_FAILED)return n.warn("AppClient can perform reset operation being in failed sync state only"),b();this.state=o.OFFLINE;var a=e.chain(this._deferredActions).pluck("modelName").uniq();return b.Promise(function(a,b){d.removeItem(this._deferredActionsStorageKey,function(c){c?b(c):(this._deferredActions=[],a())}.bind(this))}.bind(this)).then(this.goOnline).then(function(){var c=a.map(function(a){return this.dao(a).store.purge()}.bind(this)).value();return b.all(c)}.bind(this))["catch"](function(a){return this.state=o.SYNC_FAILED,b.reject(a)}.bind(this))},p.prototype.getModelListOffline=function(){return b.Promise(function(a,b){d.getItem(this._modelListStorageKey,function(c,d){n.log("Getting model list offline"),c?b(c):a(d||[])}.bind(this))}.bind(this))},p.prototype.getModelsMetaDataOnline=function(){return n.log("Getting model list online"),this.ajax("GET",this.settings._url.meta+"/model").then(function(a){return b.Promise(function(b,c){d.setItem(this._modelListStorageKey,a.models,function(d,e){d?c(d):b(a)}.bind(this))}.bind(this))}.bind(this))},p.prototype.initDAOOnline=function(a){if(e.isArray(a)){n.log("Initializing DAO list online: "+JSON.stringify(a));for(var c=[],d=0,f=a.length;f>d;d++)c[d]=this.initDAOOnline(a[d]);return b.all(c)}return n.log("Initializing DAO online: "+JSON.stringify(a)),this.ajax("GET",this.settings._url.meta+"/model/"+a).then(function(b){var c=this._daoMap[a]=new q(this,a,b);return c.init()}.bind(this))},p.prototype.initDAOOffline=function(a){if(e.isArray(a)){n.log("Initializing DAO list offline: "+JSON.stringify(a));for(var c=[],d=0,f=a.length;f>d;d++)c[d]=this.initDAOOffline(a[d]);return b.all(c)}n.log("Initializing DAO offline: "+JSON.stringify(a));var g=this._daoMap[a]=new q(this,a);return g.init()},p.prototype.setSessionToken=function(a){var c={};return c.token=a,e.isUndefined(c.token)||e.isNull(c.token)?b.reject("Incorrect session token"):e.isString(c.token)?e.isEmpty(c.token)?b.reject("Session token cannot be empty"):(this.settings.headers=this.settings.headers||{},this.settings.headers["X-Appery-Session-Token"]=c.token,b(c.token)):b.reject("Session token should be a String")},p.prototype.login=function(a,c){if(this.state===o.INITIAL)return b.reject("SDK is not initialized yet");if(!a)return b.reject("'username' is empty");if(!c)return b.reject("'password' is empty");if(this.isOffline())return b().then(function(){return b.Promise(function(b,d){-1!==e.findIndex(this._usersData,new k(a,c))?(this._currentUser=new k(a,c,!0),b()):d("Invalid username or password")}.bind(this))}.bind(this))["catch"](function(a){return n.error(a),b.reject(a)}.bind(this));var d={};return d.headers={},d.headers["Content-Type"]="application/json",d.data={username:a,password:c},this.ajax("POST",this.settings._url.security+"/login",d).then(function(b){this.settings.headers=this.settings.headers||{},this.settings.headers["X-Appery-Session-Token"]=b.sessionToken,this._usersData=[],this._usersData.push(new k(a,c)),this._currentUser=new k(a,c,!0)}.bind(this)).then(this._persistUsersData)["catch"](function(a){return n.error(a),b.reject(a)}.bind(this))},p.prototype.logout=function(){if(this.state===o.INITIAL)return b.reject("SDK is not initialized yet");if(null===this._currentUser)return b.reject("You are not logged in");if(this.isOffline())return this._currentUser=null,b.resolve();var a=this.settings.headers&&this.settings.headers["X-Appery-Session-Token"];if(!a)return b.reject("You are not logged in");var c={};return c.headers={},c.headers["Content-Type"]="application/json",c.data={token:a},this.ajax("POST",this.settings._url.security+"/logout",c).then(function(){this.settings.headers&&delete this.settings.headers["X-Appery-Session-Token"],this._currentUser=null}.bind(this))["catch"](function(a){return n.error(a),b.reject(a)}.bind(this))},p.prototype.dao=function(a){if(!a)throw new Error("Can't get DAO for empty model name");if(0===Object.keys(this._daoMap).length)throw new Error("No model has been initialized yet");var b=this._daoMap[a];if(!b)throw new Error("Model '"+a+"' not found");return b},p.prototype.folder=function(a){return{dao:function(b){for(var c=a+"/"+b;-1!==c.indexOf("//");)c=c.replace("//","/");return this.dao(c)}.bind(this)}},p.prototype.invoke=function(a,c,d){var f=this.settings._url.rest;return this.isOffline()?b.reject("Invoke can be execute only in 'online' mode"):e.isUndefined(c)||e.isNull(c)?b.reject("Invoke 'path' param is empty"):e.isString(c)?e.isEmpty(c)?b.reject("Invoke 'path' param is empty"):"GET"!==a&&"POST"!==a&&"PUT"!==a&&"DELETE"!==a?b.reject("Incorrect request method"):(("POST"===a||"PUT"===a)&&(d=d||{},d.contentType=d.contentType||"application/json"),e.endsWith(f,"/")||e.startsWith(c,"/")||(f+="/"),f+=c,d=this._buildAjaxOptions(d),this.ajax(a,f,d)):b.reject("Incorrect type for invoke 'path' param")},p.prototype.ajax=function(a,c,d){return b.Promise(function(b,f){d=d||{},d.headers=d.headers||{},e.defaults(d.headers,this.settings.headers,d.headers);var g={apiKey:this.settings.apiKey||"key_not_provided"};e.isEmpty(d.data)||"GET"!==a||(g=e.defaults(g,d.data)),c+=-1!=e.indexOf(c,"?")?"&":"?",c+=this._objectToQueryString(g);var h=new XMLHttpRequest;h.open(a,c,!0),h.onload=function(){if("20"===h.status.toString().substr(0,2))if(d.isDetailedAjaxResponceNeeded)try{b(new i(JSON.parse(h.responseText),h))}catch(a){b(new i(h.response,h))}else try{b(JSON.parse(h.responseText))}catch(a){b(h.response)}else f(h.response)},h.onerror=function(){f(new Error("Unable to send request to "+JSON.stringify(c)))},e.isEmpty(d.headers)||e.each(d.headers,function(a,b){h.setRequestHeader(b,a)}),e.isObject(d.data)&&(d.data=JSON.stringify(d.data)),h.send("GET"===a?null:d.data)}.bind(this))},p.prototype._buildAjaxOptions=function(a){var b={};return b.headers={},e.defaults(b.headers,a.headers),a.data&&(b.data=a.data),a.contentType&&(b.headers["Content-Type"]=a.contentType),b},p.prototype._objectToQueryString=function(a){if(!e.isObject(a))return a;var b=[];return e.each(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(e.isObject(a)?JSON.stringify(a):a))}),b.join("&")},p.prototype._pushDeferredActionIntoQueue=function(a){return b().then(function(){return this._deferredActions.push(e.cloneDeep(a)),this._persistDeferredActionsQueue()}.bind(this))},p.prototype._getDeferredActionsForModel=function(a){for(var b=[],c=0;c<this._deferredActions.length;c++){var d=this._deferredActions[c];d.modelName===a&&b.push(d)}return b},p.prototype._removeDeferredAction=function(a){var c=b();return c=c.then(function(){return this._deferredActions=e.without(this._deferredActions,a),this._persistDeferredActionsQueue()}.bind(this))},p.prototype._persistDeferredActionsQueue=function(){return b.Promise(function(a,b){d.setItem(this._deferredActionsStorageKey,this._deferredActions,function(c){c?b(c):a()})}.bind(this))},p.prototype._persistUsersData=function(){return b.Promise(function(a,b){d.setItem(this._usersDataStorageKey,this._usersData,function(c){c?b(c):a()})}.bind(this))},p.prototype._executeDeferredActionsQueue=function(){if(!this._deferredActions||0===this._deferredActions.length)return b();for(var a=b(),c=0;c<this._deferredActions.length;c++){var d=this._deferredActions[c];a=a.then(e.partial(this.dao(d.modelName)._performDeferredAction,d)),a=a.then(function(a){return this._deferredActions.shift(),a instanceof j&&(e.isUndefined(a.autogeneratedId)||e.isUndefined(a.realId)||e.forEach(this._deferredActions,function(b){var c=b.options.data;if(!e.isUndefined(c)){var d=function(b){e.forEach(b,function(c,f){e.isObject(c)?d(c):c===a.autogeneratedId&&(b[f]=a.realId)})};d(c)}e.endsWith(b.url,a.autogeneratedId)&&(b.url=b.url.replace(a.autogeneratedId,a.realId))})),this._persistDeferredActionsQueue()}.bind(this))}return a},l.prototype=new Error,l.prototype.constructor=l,m.prototype=new Error,m.prototype.constructor=m,g.addFormat("date",function(a,b){var c=["YYYYMMDD","YYYY-MM-DD","YYYY-MM","YYYY","YY","YYYYDDD","YYYY-DDD","YYYY[W]wwD","YYYY-[W]ww-D","YYYY[W]ww","YYYY-[W]ww"];return f(a,c,!0).isValid()?null:"A valid ISO 8601 date format expected"}),g.addFormat("date-time",function(a,b){var c=["YYYYMMDDTHHmmss","YYYYMMDDTHHmmssZ","YYYYMMDDTHHmmss+HHmm","YYYYMMDDTHHmmss-HHmm","YYYYMMDDTHHmmss+HH","YYYYMMDDTHHmmss-HH","YYYY-MM-DDTHH:mm:ss","YYYY-MM-DDTHH:mm:ssZ","YYYY-MM-DDTHH:mm:ss+HH:mm","YYYY-MM-DDTHH:mm:ss-HH:mm","YYYY-MM-DDTHH:mm:ss+HH","YYYY-MM-DDTHH:mm:ss-HH","YYYYMMDDTHHmm","YYYY-MM-DDTHH:mm","YYYYDDDTHHmmZ","YYYY-DDDTHH:mmZ","YYYY[W]wwDTHHmm+HHmm","YYYY[W]wwDTHHmm-HHmm","YYYY-[W]ww-DTHH:mm+HH","YYYY-[W]ww-DTHH:mm-HH","YYYY-MM-DDTHH:mm:ss.SSSS","YYYYMMDD HHmmss","YYYYMMDD HHmmssZ","YYYYMMDD HHmmss+HHmm","YYYYMMDD HHmmss-HHmm","YYYYMMDD HHmmss+HH","YYYYMMDD HHmmss-HH","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD HH:mm:ssZ","YYYY-MM-DD HH:mm:ss+HH:mm","YYYY-MM-DD HH:mm:ss-HH:mm","YYYY-MM-DD HH:mm:ss+HH","YYYY-MM-DD HH:mm:ss-HH","YYYYMMDD HHmm","YYYY-MM-DD HH:mm","YYYYDDD HHmmZ","YYYY-DDD HH:mmZ","YYYY[W]wwD HHmm+HHmm","YYYY[W]wwD HHmm-HHmm","YYYY-[W]ww-D HH:mm+HH","YYYY-[W]ww-D HH:mm-HH","YYYY-MM-DD HH:mm:ss.SSSS","YYYY-MM-DD HH:mm:ss.SSS"];return f(a,c,!0).isValid()?null:"A valid ISO 8601 date/time string expected"}),g.addFormat("time",function(a,b){var c=["HHmmss","HH:mm:ss","HHmm","HH:mm","HH","HHmmss.ss","HH:mm:ss.ss","HHmm.mm","HH:mm.mm","HHmmssZ","HHmmZ","HHZ","HH:mm:ssZ","HH:mmZ","HHmmss+HHmm","HHmmss-HHmm","HHmmss+HH","HHmmss-HH","HH:mm:ss+HH:mm","HH:mm:ss-HH:mm","HH:mm:ss+HH","HH:mm:ss-HH"];return f(a,c,!0).isValid()?null:"A valid ISO 8601 time string expected"});var q=function(a,b,c){e.bindAll(this,"init","create","get","update","delete","find","validate","_deferAction","_performDeferredAction"),this.sdk=a,this.modelName=b,this.meta=c,this._metaStorageKey="model-meta:"+b,this.store=new r(this)};q.prototype.init=function(){return b.Promise(function(a,b){this.meta?d.setItem(this._metaStorageKey,this.meta,function(c,d){c?b(c):a(this)}.bind(this)):d.getItem(this._metaStorageKey,function(c,d){c?b(c):d?(this.meta=d,a(this)):b("No offline metadata for model "+this.modelName)}.bind(this))}.bind(this))},q.prototype._deferAction=function(a,b,c){return this.sdk._pushDeferredActionIntoQueue({modelName:this.modelName,method:a,url:b,options:c})},q.prototype._performDeferredAction=function(a){if("POST"===a.method){var b=a.options.data[this.meta.idAttribute];if(e.isString(b)&&-1!==b.indexOf("__tmp_entity_id__"))return delete a.options.data[this.meta.idAttribute],this.sdk.ajax(a.method,a.url,a.options).then(function(a){return this.store.set(a),new j(b,a[this.meta.idAttribute],a)}.bind(this))["finally"](function(){this.store.evict(b)}.bind(this))}return this.sdk.ajax(a.method,a.url,a.options)},q.prototype.create=function(a,c){if(!this.meta.api.create||!this.meta.api.create.url)return b.reject("Action 'create' is not supported by model "+this.modelName);c=c||{};try{this.validate(a)}catch(d){return b.reject(d)}a=e.cloneDeep(a),c=e.cloneDeep(c),c.data=a,c.contentType=c.contentType||"application/json",c=this.sdk._buildAjaxOptions(c);var f={},g=this._processURL(this.meta.api.create.url,f);if(this.sdk.isOffline()){var h=c.data[this.meta.idAttribute];if(e.isUndefined(h)||e.isNull(h))c.data[this.meta.idAttribute]="__tmp_entity_id__"+(Math.floor(1e6*Math.random()-1)+1e6);else if(this.store.get(h))return b.reject("Entity with id "+h+" already exists");return this._deferAction("POST",g,c).then(function(){return this.store.set(c.data),b(c.data)}.bind(this))}return this.sdk.ajax("POST",g,c).then(function(a){try{return this.store.set(a),b(a)}catch(c){return b.reject(c.message)}}.bind(this))},q.prototype.get=function(a,c){if(!this.meta.api.get||!this.meta.api.get.url)return b.reject("Action 'get' is not supported by model "+this.modelName);if(e.isUndefined(a)||e.isNull(a))return b.reject("Can't perform 'get' on "+this.modelName+", object ID is empty");if(this.sdk.isOffline()){var d=this.store.get(a);return d?b(d):b.reject("Entity with id "+a+" not found in storage")}c=c||{},c=this.sdk._buildAjaxOptions(c);var f={},g={};g[this.meta.idAttribute]=a,e.defaults(f,this.sdk.urlParams,g);var h=this._processURL(this.meta.api.get.url,f);return this.sdk.ajax("GET",h,c).then(function(a){try{return this.store.set(a),b(a)}catch(c){return b.reject(c.message)}}.bind(this))},q.prototype.update=function(a,c,d){if(!this.meta.api.update||!this.meta.api.update.url)return b.reject("Action 'update' is not supported by model "+this.modelName);if(e.isUndefined(a)||e.isNull(a))return b.reject("Can't update entity by empty id");try{this.validate(c)}catch(f){return b.reject(f)}if(d=d||{},c=e.cloneDeep(c),d=e.cloneDeep(d),d.data=e.omit(c,this.meta.idAttribute),e.isEmpty(d.data))return b.reject("Can't update entity with nothing");d.contentType=d.contentType||"application/json",d=this.sdk._buildAjaxOptions(d);var g={};g[this.meta.idAttribute]=a;var h=this._processURL(this.meta.api.update.url,g);if(this.sdk.isOffline()){var i=this.store.get(a);return i?this._deferAction("PUT",h,d).then(function(){return this.store.evict(a),this.store.set(e.extend(i,d.data)),b(i)}.bind(this)):b.reject("Entity with id "+a+" not found")}return this.sdk.ajax("PUT",h,d).then(function(c){try{return this.store.evict(a),this.store.set(c),b(c)}catch(d){return b.reject(d.message)}}.bind(this))},q.prototype["delete"]=function(a,c){if(!this.meta.api["delete"]||!this.meta.api["delete"].url)return b.reject("Action 'delete' is not supported by model "+this.modelName);if(e.isUndefined(a)||e.isNull(a))return b.reject("Can't perform 'delete' on "+this.modelName+", object ID is empty");c=c||{};var d={},f={};f[this.meta.idAttribute]=a,e.defaults(d,this.sdk.urlParams,f);var g=this._processURL(this.meta.api["delete"].url,d);if(c=this.sdk._buildAjaxOptions(c),this.sdk.isOffline()){var h=this.store.get(a);return h?this._deferAction("DELETE",g,c).then(function(){return this.store.evict(a),b(h)}.bind(this)):b.reject("Entity with id "+a+" not found")}return this.sdk.ajax("DELETE",g,c).then(function(c){try{return this.store.evict(a),b(c)}catch(d){return b.reject(d.message)}}.bind(this))},q.prototype.getCount=function(a,c){if(!this.meta.api.find||!this.meta.api.find.url)return b.reject("Action 'find' is not supported by model "+this.modelName);a=a||{},c=c||{};var d={where:a,count:!0},f={};if(this.sdk.isOffline()){try{f.count=this.store.find(d.where).length}catch(g){return b.reject("Internal SDK error occurs")}return b(f)}var h={},i=this._processURL(this.meta.api.find.url,h);return c=this.sdk._buildAjaxOptions(c),c.data=d,c.isDetailedAjaxResponceNeeded=!0,this.sdk.ajax("GET",i,c).then(function(c){var d=b();try{e.isEmpty(a)&&(d=d.then(this.store.purge)),d=d.then(function(){if(this.store.set(c.data),f.count=c.httpRequest.getResponseHeader("X-Total-Count"),e.isUndefined(f.count)||e.isNull(f.count))return b.reject("Error getting count from server. Server returned empty count value.");try{f.count=parseInt(f.count)}catch(a){return b.reject("Error getting count from server. Server returned invalid count value.")}return b(f)}.bind(this))}catch(g){d.reject(g.message)}return d}.bind(this))},q.prototype.find=function(a,c){if(!this.meta.api.find||!this.meta.api.find.url)return b.reject("Action 'find' is not supported by model "+this.modelName);a=a||{},c=c||{};var d={where:a};if(!e.isUndefined(c.offset)){if(!(c.offset-0)==c.offset&&(""+c.offset).trim().value>0)return b.reject("Invalid offset option type. Should be a number.");if(c.offset<0)return b.reject("Invalid offset option value. Should not be negative.");d.offset=c.offset}if(!e.isUndefined(c.limit)){if(!(c.limit-0)==c.limit&&(""+c.limit).trim().value>0)return b.reject("Invalid limit option type. Should be a number.");if(c.limit<0)return b.reject("Invalid limit option value. Should not be negative.");d.limit=c.limit}if(this.sdk.isOffline()){var f=this.store.find(d.where);return e.isUndefined(d.offset)||(f=e.slice(f,d.offset,f.length)),!e.isUndefined(d.limit)&&d.limit<f.length&&(f=e.take(f,d.limit)),b(f)}var g={},h=this._processURL(this.meta.api.find.url,g);return c=this.sdk._buildAjaxOptions(c),c.data=d,this.sdk.ajax("GET",h,c).then(function(c){var d=b();try{e.isEmpty(a)&&(d=d.then(this.store.purge)),d=d.then(function(){return this.store.set(c),b(c)}.bind(this))}catch(f){d.reject(f.message)}return d}.bind(this))},q.prototype.validate=function(a){if(this.sdk.settings.isDataValidationEnabled){if(!a)throw new m("'data' is empty");if(this.sdk.isOffline()){var b=[];e.pick(a,function(a,c){e.isString(a)&&-1!==a.indexOf("__tmp_entity_id__")&&b.push(c)});var c=g.validateMultiple(a,this.meta.schema,!1,!0);if(!c.valid)for(var d=0;d<c.errors.length;d++){var f,h=c.errors[d];if(f=h.message,h.dataPath){var i=h.dataPath.replace("/","");if(-1!==e.indexOf(b,i))continue;throw f+=". Data Path: "+h.dataPath,new m(f)}}}else if(!g.validate(a,this.meta.schema,!1,!0)){var h=g.error.message;throw g.error.dataPath&&(h+=". Data Path: "+g.error.dataPath),new m(h)}}},q.prototype._processURL=function(a,b){try{return a.replace(/\{([^{}"':]+?)}/g,function(a,c){return e.isUndefined(b[c])||e.isNull(b[c])?a:b[c]})}catch(c){return n.error("URL parameters substitution error: "+c.message),a}};var r=function(a){e.bindAll(this,"set","get","evict","find","purge","_loadCache","_persistCache"),this.dao=a,this._dataStorageKey="model-data:"+this.dao.modelName,this._loadCache(),this._emitChange=e.debounce(function(){this.emit("change")},150),this.on("change",this._persistCache)};return r.prototype=e.clone(c.prototype),r.prototype.set=function(a){if(e.isString(a))try{a=JSON.parse(a)}catch(b){return new Error("'data' in not a valid JSON")}else a=e.cloneDeep(a);for(var c=e.isArray(a)?a:[a],d=0,f=c.length;f>d;d++){var g=c[d];this._store[g[this.dao.meta.idAttribute]]=g}this._emitChange()},r.prototype.get=function(a){if(void 0!==a){if(e.isObject(a))throw new Error("Key must be a primitive");var b=this._store[a];return!e.isUndefined(b)&&e.isObject(b)&&(b=e.cloneDeep(b)),b}},r.prototype.evict=function(a){if(e.isObject(a))throw new Error("Key must be a primitive");var b=delete this._store[a];return this._emitChange(),b},r.prototype.find=function(a){if(a=a||{},e.isObject(a))return e.cloneDeep(e.query(e.values(this._store),a));throw new Error("Invalid query")},r.prototype.purge=function(){return b.Promise(function(a,b){d.removeItem(this._dataStorageKey,function(c){c?b(c):(this._store={},a())}.bind(this))}.bind(this))},r.prototype._persistCache=function(){return b.Promise(function(a,b){d.setItem(this._dataStorageKey,this._store,function(c,d){c?(n.error(c),b(c)):a(d)}.bind(this))}.bind(this))},r.prototype._loadCache=function(){return b.Promise(function(a,b){d.getItem(this._dataStorageKey,function(c,d){c?(n.error(c),b(c)):(this._store=d||{},a(d))}.bind(this))}.bind(this))},new p});