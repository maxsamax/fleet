(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=[].slice,B=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},C={}.hasOwnProperty;for(p=this,w={},v=function(){var a;return a={},["every","some","filter","reduce","map"].forEach(function(b){return a[b]=function(){var a,c;return c=arguments[0],a=2<=arguments.length?A.call(arguments,1):[],c[b].apply(c,a)}}),a.keys=Object.keys,a.isArray=Array.isArray,a.result=function(a,b){return null==a&&(a={}),"Function"===w.getType(a[b])?a[b]():a[b]},a.detect=function(a,b){var c,d,e;for(d=0,e=a.length;e>d;d++)if(c=a[d],b(c))return c},a.reject=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],b(c)||f.push(c);return f},a.intersection=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],-1!==b.indexOf(c)&&f.push(c);return f},a.isEqual=function(a,b){return JSON.stringify(a)===JSON.stringify(b)},a},d=function(a){var b,c,d,e;for(e=["every","some","filter","detect","reject","reduce","intersection","isEqual","keys","isArray","result","map"],c=0,d=e.length;d>c;c++)if(b=e[c],w[b]=a[b],!w[b])throw new Error(""+b+" missing. Please ensure that you first initialize underscore-query with either lodash or underscore")},w.getType=function(a){var b;return b=Object.prototype.toString.call(a).substr(8),b.substr(0,b.length-1)},w.makeObj=function(a,b){var c;return(c={})[a]=b,c},w.reverseString=function(a){return a.toLowerCase().split("").reverse().join("")},w.compoundKeys=["$and","$not","$or","$nor"],w.makeGetter=function(a){return a=a.split("."),function(b){var c,d,e,f;for(d=b,e=0,f=a.length;f>e;e++)c=a[e],d&&(d=w.result(d,c));return d}},i=function(a,b){var c,d,e;e=[];for(c in b)d=b[c],e.push(w.makeObj(a,w.makeObj(c,d)));return e},k=function(a){var b,c,d,e,f,g;switch(b=w.keys(a)[0],e=a[b],c={key:b},(null!=e?e.$boost:void 0)&&(c.boost=e.$boost,delete e.$boost),-1!==b.indexOf(".")&&(c.getter=w.makeGetter(b)),d=w.getType(e)){case"RegExp":case"Date":c.type="$"+d.toLowerCase(),c.value=e;break;case"Object":if(B.call(w.compoundKeys,b)>=0)c.type=b,c.value=m(e),c.key=null;else if(w.keys(e).length>1)c.type="$and",c.value=m(i(b,e)),c.key=null;else for(f in e)if(C.call(e,f)){if(g=e[f],!u(f,g))throw new Error("Query value ("+g+") doesn't match query type: ("+f+")");switch(c.type=f,f){case"$elemMatch":c.value=s(l(g));break;case"$endsWith":c.value=w.reverseString(g);break;case"$likeI":case"$startsWith":c.value=g.toLowerCase();break;case"$not":case"$nor":case"$or":case"$and":c.value=m(w.makeObj(c.key,g)),c.key=null;break;case"$computed":c=k(w.makeObj(b,g)),c.getter=w.makeGetter(b);break;default:c.value=g}}break;default:c.type="$eq",c.value=e}return"$eq"!==c.type||"Object"!==d&&"Array"!==d||(c.type="$deepEqual"),c},m=function(a){var b,c,d,e,f,g,h;for(d=w.isArray(a)?a:function(){var c;c=[];for(b in a)C.call(a,b)&&(e=a[b],c.push(w.makeObj(b,e)));return c}(),h=[],f=0,g=d.length;g>f;f++)c=d[f],h.push(k(c));return h},u=function(a,b){var c;switch(c=w.getType(b),a){case"$in":case"$nin":case"$all":case"$any":return"Array"===c;case"$size":return"Number"===c;case"$regex":case"$regexp":return"RegExp"===c;case"$like":case"$likeI":return"String"===c;case"$between":case"$mod":return"Array"===c&&2===b.length;case"$cb":return"Function"===c;default:return!0}},t=function(a,b){var c;switch(c=w.getType(b),a){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===c;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===c;case"$size":return"String"===c||"Array"===c;case"$in":case"$nin":return null!=b;default:return!0}},n=function(a,b,c,d,e){switch(a){case"$eq":return w.isArray(c)?B.call(c,b)>=0:c===b;case"$deepEqual":return w.isEqual(c,b);case"$contains":return B.call(c,b)>=0;case"$ne":return c!==b;case"$lt":return b>c;case"$gt":return c>b;case"$lte":return b>=c;case"$gte":return c>=b;case"$between":return b[0]<c&&c<b[1];case"$betweene":return b[0]<=c&&c<=b[1];case"$in":return B.call(b,c)>=0;case"$nin":return B.call(b,c)<0;case"$all":return w.every(b,function(a){return B.call(c,a)>=0});case"$any":return w.some(c,function(a){return B.call(b,a)>=0});case"$size":return c.length===b;case"$exists":case"$has":return null!=c===b;case"$like":return-1!==c.indexOf(b);case"$likeI":return-1!==c.toLowerCase().indexOf(b);case"$startsWith":return 0===c.toLowerCase().indexOf(b);case"$endsWith":return 0===w.reverseString(c).indexOf(b);case"$type":return typeof c===b;case"$regex":case"$regexp":return b.test(c);case"$cb":return b.call(d,c);case"$mod":return c%b[0]===b[1];case"$elemMatch":return q(c,b,null,!0);case"$and":case"$or":case"$nor":case"$not":return o(a,b,e,d);default:return!1}},s=function(a,b,c){var d,e;if("String"===w.getType(b)&&(d=b,b=function(a,b){return a[d](b)}),c){if(1!==a.length)throw new Error("score operations currently don't work on compound queries");if(e=a[0],"$and"!==e.type)throw new Error("score operations only work on $and queries (not "+e.type);return function(a){return a._score=o(e.type,e.parsedQuery,b,a,!0),a}}return function(d){var f,g;for(f=0,g=a.length;g>f;f++)if(e=a[f],!o(e.type,e.parsedQuery,b,d,c))return!1;return!0}},o=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p;for(h=0,j=0,k=1/b.length,m=0,o=b.length;o>m;m++)switch(i=b[m],f=i.getter?i.getter(d,i.key):c?c(d,i.key):d[i.key],l=t(i.type,f),l&&(l=n(i.type,i.value,f,d,c)),l&&(h++,e&&(g=null!=(p=i.boost)?p:1,j+=k*g)),a){case"$and":if(!e&&!l)return!1;break;case"$not":if(l)return!1;break;case"$or":if(l)return!0;break;case"$nor":if(l)return!1;break;default:throw new Error("Invalid compound method")}return e?j:"$not"===a?0===h:"$or"!==a},l=function(a){var b,c,d,e,f;if(d=w.keys(a),!d.length)return[];if(b=w.intersection(w.compoundKeys,d),0===b.length)return[{type:"$and",parsedQuery:m(a)}];if(b.length!==d.length){B.call(b,"$and")<0&&(a.$and={},b.unshift("$and"));for(c in a)C.call(a,c)&&(f=a[c],B.call(w.compoundKeys,c)<0&&(a.$and[c]=f,delete a[c]))}return function(){var c,d,f;for(f=[],c=0,d=b.length;d>c;c++)e=b[c],f.push({type:e,parsedQuery:m(a[e])});return f}()},j=function(a){var b;return"String"===w.getType(a)&&(b=a,a=function(a,c){return a[b](c)}),a},a=function(){function a(a,b){this.items=a,this._getter=b,this.theQuery={}}return a.prototype.all=function(a,b){return a&&(this.items=a),a=this.indexes?this.getIndexedItems(this.items):this.items,q(a,this.theQuery,this._getter,b)},a.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},a.prototype.tester=function(){return h(this.theQuery,this._getter)},a.prototype.first=function(a){return this.all(a,!0)},a.prototype.getter=function(a){return this._getter=a,this},a}(),b=function(a){return function(b,c){var d;return c&&(b=w.makeObj(b,c)),null==(d=this.theQuery)[a]&&(d[a]=[]),this.theQuery[a].push(b),this}},z=w.compoundKeys,x=0,y=z.length;y>x;x++)g=z[x],a.prototype[g.substr(1)]=b(g);return a.prototype.find=a.prototype.query=a.prototype.run=a.prototype.all,c=function(b,c){return new a(b,c)},h=function(a,b){return s(l(a),j(b))},f=function(a,b,c){return q(a,b,c,!0)},q=function(a,b,d,e,f){var g;return arguments.length<2?c.apply(this,arguments):(d&&(d=j(d)),"Function"!==w.getType(b)&&(b=s(l(b),d,f)),(g=f?w.map:e?w.detect:w.filter)(a,b))},r=function(a,b,c){return q(a,b,c,!1,!0)},q.build=c,q.parse=l,q.findOne=q.first=f,q.score=r,q.tester=q.testWith=h,q.getter=q.pluckWith=w.makeGetter,e=function(a,b){return null==b&&(b=!0),a||(a=v(),b=!1),d(a),b&&a.mixin({query:q,q:q}),q},p._?e(p._):exports&&("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=e:e}).call(this);